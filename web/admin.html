<html>
<body>

<h1>Add App Handler</h1>

<p>This page allows you (and by <em>you</em> I mean users who are allowed to), to set up an app/github js file mapping.</p>

<button id='signin' onclick='navigator.id.request();'>Sign In</button>
<button id='signout' onclick='navigator.id.logout();'>Sign Out</button>

<div id="entry" style='display: none'>
	<input style='width: 400px' type="text" id="appPath" value="http://kybernetikos.github.com/DarkBinder/web/index.html" />
	<input style='width: 400px' type="text" id="github" value="kybernetikos/DarkBinder/example/TestApp.js:gh-pages" />
	<button id="submit" onclick="registerIndexApp();">Submit</button>
	<pre id="message">Not currently signed in.</pre>
</div>

<!-- Scripts -->
<script src="https://darkbinder.herokuapp.com/socket.io/socket.io.js"></script>
<script src="https://login.persona.org/include.js"></script>
<script>
	var socket = null;
	var msgArea = document.getElementById('message');

	function socketIOConnect(assertion) {
		socket = io.connect('https://darkbinder.herokuapp.com/?assertion='+assertion);
		msgArea.innerHTML = "Signed in, connecting...";

		socket.on('message', function(data) {
			msgArea.innerHTML = "RESPONSE: "+JSON.stringify(data);
		});

		socket.on('disconnect', function() {
			msgArea.innerHTML = "Disconnected.";
		});
	}

	var currentUser = null;
	navigator.id.watch({
		loggedInUser: currentUser,
		onlogin: function(assertion) {
			document.getElementById('entry').style.display = '';
			msgArea.innerHTML = "Signed in.";
			socketIOConnect(assertion);
		},
		onlogout: function() {
			msgArea.innerHTML = "Logging out.";
			document.getElementById('entry').style.display = 'none';
			if (socket != null) socket.disconnect();
		}
	});

	function registerIndexApp() {
		msgArea.innerHTML = "Sending command.";
		var githubFile = doucment.getElementById('github').value;
		var pathBranch = githubFile.split(":");
		var branch = undefined;
		if (pathBranch.length > 1) {
			branch = pathBranch[1];
		}
		var parts = pathBranch[0].split("/");
		var user = parts.shift();
		var repository = parts.shift();

		var commandPayload = {
			appPath: document.getElementById('appPath').value,
			action: 'module.load',

			user: user,
			branch: branch,
			repository: repository,
			path: parts.join("/")
		};
		console.log('sending', commandPayload);
		socket.emit('message', commandPayload);
	}
</script>
</body>
</html>